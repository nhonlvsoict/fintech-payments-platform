databaseChangeLog:
  - changeSet:
      id: 001-init
      author: nhonlv
      changes:
        - createTable:
            tableName: clients
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true } }
              - column: { name: name, type: varchar(120), constraints: { nullable: false } }
              - column: { name: created_at, type: timestamp with time zone, constraints: { nullable: false } }

        - createTable:
            tableName: payments
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true } }
              - column: { name: client_id, type: uuid, constraints: { nullable: false } }
              - column: { name: amount_minor, type: bigint, constraints: { nullable: false } }
              - column: { name: currency, type: varchar(3), constraints: { nullable: false } }
              - column: { name: status, type: varchar(30), constraints: { nullable: false } }
              - column: { name: created_at, type: timestamp with time zone, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: payments
            baseColumnNames: client_id
            referencedTableName: clients
            referencedColumnNames: id
            constraintName: fk_payments_client
  - changeSet:
      id: 002-seed-client
      author: nhonlv
      changes:
        - insert:
            tableName: clients
            columns:
              - column: { name: id, value: "11111111-1111-1111-1111-111111111111" }
              - column: { name: name, value: "demo-fintech" }
              - column: { name: created_at, valueComputed: "now()" }
  - changeSet:
      id: 003-idempotency
      author: nhon
      changes:
        - createTable:
            tableName: idempotency_keys
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true } }
              - column: { name: client_id, type: uuid, constraints: { nullable: false } }
              - column: { name: idempotency_key, type: varchar(120), constraints: { nullable: false } }
              - column: { name: request_hash, type: varchar(64), constraints: { nullable: false } }
              - column: { name: status, type: varchar(20), constraints: { nullable: false } }
              - column: { name: response_code, type: int }
              - column: { name: response_body, type: jsonb }
              - column: { name: created_at, type: timestamp with time zone, constraints: { nullable: false } }
              - column: { name: updated_at, type: timestamp with time zone, constraints: { nullable: false } }

        - addUniqueConstraint:
            tableName: idempotency_keys
            columnNames: client_id, idempotency_key
            constraintName: uq_idem_client_key

